<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Three.js FBX Viewer</title>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        canvas { 
            display: block; 
        }
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            color: white;
            z-index: 100;
        }
        #file-input {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #info {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <h3 style="margin-top: 0;">FBX Viewer</h3>
        <input type="file" id="file-input" accept=".fbx" />
        <div id="info">FBXファイルを選択してください</div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/examples/jsm/loaders/FBXLoader.js": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/FBXLoader.js",
        "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js"
      }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/examples/jsm/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls;
        let mixer;
        let currentModel = null;
        const clock = new THREE.Clock();

        function init() {
            // シーン
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xa0a0a0);

            // カメラ
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(100, 200, 300);

            // ライト
            scene.add(new THREE.HemisphereLight(0xffffff, 0x8d8d8d, 3));
            const dirLight = new THREE.DirectionalLight(0xffffff, 3);
            dirLight.position.set(0, 200, 100);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // レンダラー
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // コントロール
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 100, 0);
            controls.update();

            // 床
            const grid = new THREE.GridHelper(2000, 20, 0x000000, 0x000000);
            grid.material.opacity = 0.2;
            grid.material.transparent = true;
            scene.add(grid);

            // ファイル選択イベント
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.fbx')) {
                document.getElementById('info').textContent = 'エラー: FBXファイルを選択してください';
                return;
            }

            document.getElementById('info').textContent = '読み込み中...';

            // 既存のモデルを削除
            if (currentModel) {
                scene.remove(currentModel);
                currentModel = null;
            }
            if (mixer) {
                mixer.stopAllAction();
                mixer = null;
            }

            // ファイルを読み込む
            const reader = new FileReader();
            reader.onload = function(e) {
                loadFBX(e.target.result, file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        function loadFBX(arrayBuffer, filename) {
            const loader = new FBXLoader();

            try {
                const object = loader.parse(arrayBuffer, '');
                
                // モデルのセットアップ
                object.scale.setScalar(1);
                object.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                // モデルの境界ボックスを計算してカメラを調整
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                cameraZ *= 2.5;

                camera.position.set(center.x + cameraZ, center.y + cameraZ, center.z + cameraZ);
                controls.target.copy(center);
                controls.update();

                scene.add(object);
                currentModel = object;

                // アニメーション
                let animInfo = 'アニメーションなし';
                if (object.animations && object.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(object);
                    const clip = object.animations[0];
                    const action = mixer.clipAction(clip);
                    action.play();
                    animInfo = `アニメーション: ${clip.name} (${object.animations.length}個)`;
                }

                document.getElementById('info').textContent = `${filename} を読み込みました
${animInfo}`;

            } catch (error) {
                console.error('FBX読み込みエラー:', error);
                document.getElementById('info').textContent = 'エラー: FBXファイルの読み込みに失敗しました';
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            if (mixer) {
                mixer.update(delta);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        init();
        animate();
    </script>
</body>
</html>